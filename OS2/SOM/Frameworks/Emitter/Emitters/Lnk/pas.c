/*
 *  This file was generated by the SOM Compiler and Emitter Framework.
 *  Generated using template emitter:
 *      SOM Emitter emitctm: 2.23.1.9
 */

#ifndef SOM_Module_pas_Source
#define SOM_Module_pas_Source
#endif
#define PascalEmitter_Class_Source

#include "pas.ih"
#include <scparm.h>
#include <sctdef.h>
#include <scseqnce.h>
#include <scmodule.h>
#include <scstruct.h>
#include <scconst.h>
#include <scenum.h>
#include <scenumnm.h>
#include <scunion.h>
#include <scattrib.h>
#include <scclass.h>
#include <string.h>
#include <stdio.h>

#define DEBUG

#ifdef DEBUG
  #define debug(s,...) somPrintf(__func__"(): "##s"\n" ,##__VA_ARGS__)
#else
  #define debug(x, ...)
#endif

boolean flag=FALSE; // Используется, чтоб секция Prolog отрабатывалась один раз.

/*
 * Управление последовательностью секций
 */

SOM_Scope boolean  SOMLINK somtGenerateSections(PascalEmitter *somSelf)
{
  char *DllName;
  char *obj;
  char buf[1024];
  SOMTTemplateOutputC   *template = __get_somtTemplate(somSelf);
  SOMTClassEntryC       *cls = __get_somtTargetClass(somSelf);
//  PascalEmitterData     *EmitterData = PascalEmitterGetData(somSelf);

  PascalEmitterMethodDebug("PascalEmitter","somtGenerateSections");

 if ( cls )
 {
   DllName=_somtGetGlobalModifierValue(somSelf, "dllname");
   if (!DllName) DllName= _somtGetModifierValue(cls,"dllname");
   if (!DllName) DllName=_somtGetModifierValue(cls,"filestem");
//   if (strlen(DllName)) strlcpy(buf, DllName, 9);
   strcpy(buf, DllName);
   _somtSetSymbolCopyBoth(template, "lnkDLLName", buf );
 };

 if ( cls )
 {
   obj = _somtGetGlobalModifierValue(somSelf, "file");
   _somtSetSymbolCopyBoth(template, "lnkObjects", obj);

   obj = _somtGetGlobalModifierValue(somSelf, "include");

   if (obj)
   {
    FILE *fp;
    char *content;

     fp = fopen(obj, "r" );
     if( fp != NULL )
     {
       long length = 0;
       fseek(fp, 0, SEEK_END);
       length = ftell(fp);
       fseek(fp, 0, SEEK_SET);

       content=malloc(length);
       fread(content, length, 1, fp);
       fclose(fp);
       _somtSetSymbolCopyBoth(template, "lnkInclude", content);
       free(content);
     }
   }

   obj = _somtGetGlobalModifierValue(somSelf, "lib");
   _somtSetSymbolCopyBoth(template, "lnkLibs", obj);
 };

  _somtFileSymbols(somSelf);

  if (!flag)
  {
    _somtEmitProlog(somSelf);
    flag=TRUE;
  }


  if ( cls )
  {
    _somtEmitClass(somSelf);
  }

  return TRUE;
}


/*
 * Эмитер интерфейса
 */

SOM_Scope void  SOMLINK somtEmitInterface(PascalEmitter *somSelf,
                                          SOMTClassEntryC* intfc)
{
    /* PascalEmitterData *somThis = PascalEmitterGetData(somSelf); */
    PascalEmitterMethodDebug("PascalEmitter","somtEmitInterface");

    PascalEmitter_parent_SOMTEmitC_somtEmitInterface(somSelf,
                                                     intfc);
}


/*
 * Эмитер класса
 */

SOM_Scope void  SOMLINK somtEmitClass(PascalEmitter *somSelf)
{
//  SOMTTemplateOutputC   *template;
//  char                  cBuf[9];
//  SOMTClassEntryC       *cls = __get_somtTargetClass(somSelf);
//  SOMTClassEntryC       *bc;
  PascalEmitterMethodDebug("PascalEmitter","somtEmitClass");

  PascalEmitter_parent_SOMTEmitC_somtEmitClass(somSelf);
}

